# NIP-0003 - QR Library Specification

## Summary

```
    NIP: ?
    Layer: Library
    Title: QR Library Specification
    Author: Anthony Law <anthonylaw@nem.my>
    Co-Author: Aleix <aleix@nemeurope.eu>
    Discussions-To: [Nemtech NIP](https://github.com/nemtech/NIP/issues/3)
    Comments-URI: <links to issue page for comments>
    Status: Draft
    Type: Standards Track
    Created: 2018-7-15
    License: MIT
```

## Introduction/Abstract

The purpose of this NIP is to create/define QR library specification standard. Which allows generating QRCode for NEM wallet backups, creating payment requests (invoices) and adding address to a contacts list.

The benefit for standardizing QR library specification is to help all SDKs in adopting a common QR schema.

## Motivation

In NIS1 there was not a standard, each project used a variation of a QR code schema. It always confuses developer, In addition, it doesn't support mosaics for invoice.

In addition,  user announce transactions without sharing the private key, using only trusted wallets. it will really improve user experience easy to use and increase the security because users will be able to send transactions without sharing the private key across the network.

## Design Decisions

In Catapult version, it supports cross chain transaction and decentralized asset swap. I foresee in the near future that will be a lot of side chain running on enterprise or business, and they perform cross chain transaction with the NEM mainnet.
To standardize the QR code schema is easy for the developer to apply it. we have many different types of transaction in NEM blockchain.

Base on this QR scheme, we should have an independent library and it should be able to communicate with current existing SDK.

QR library has to generate transaction **output** and **input** for SDK to process the transaction.

## Specification

The table below shows, all the **required** field using in QR code standard parameters.

| **field** | **type** | **detail**                              |
| --------- |----------| --------------------------------------- |
| schema    | integer  | 1 = add contract \| 2 = transaction \| 3 = import/export account |
| chain     | object   | Chain id use for cross-chain interoperability                  |
| type      | object   | [TransferTransaction](https://nemtech.github.io/concepts/transfer-transaction.html#id1) \| [AggregateTransaction](https://nemtech.github.io/concepts/aggregate-transaction.html#id1)  \| [CosignatureTransaction](https://nemtech.github.io/concepts/aggregate-transaction.html#cosignature-transaction)   |
| data      | object   | dataset                                 |

### Add wallet contact
```
{
  "schema": 1,
  "network": "MAIN_NET",
  "nem_version": "Catapult",
  "data": {
    "address": "NA...."
  }
}
```

### Transaction (request Assets / Invoice)
```
{
  "schema": 2,
  "network": "MAIN_NET",
  "nem_version": "Catapult",
  "type": "TransferTransaction",
  "data": {
    "recipient": "NA....",
    "assets": [
      {
        "id": "nem:xem",
        "relativeQuantity": 1
      }
    ],
    "message": {
      "type": 1,
      "payload": "my message"
    }
  }
}
```

### Transaction  (AggregateCompleteTransaction / multiple transaction with different invoice)
```
{
  "schema": 2,
  "network": "MAIN_NET",
  "nem_version": "Catapult",
  "type": "AggregateTransaction",
  "data": {
    "AggregateCompleteTransaction": [
      {
        "recipient": "NA....",
        "assets": [
          {
            "id": "nem:xem",
            "relativeQuantity": 1
          }
        ],
        "message": {
          "type": 1,
          "payload": "my message"
        }
      }
    ]
  }
}
```

### Transaction (Co-sign Transaction)
```
{
  "schema": 2,
  "network": "MAIN_NET",
  "nem_version": "Catapult",
  "type": "CosignatureTransaction",
  "data": {
    "AggregateBondedTransaction": [
      {
        "hash": "6714c22c89c81c656fb771a0492bda7bce6195f7d3ce10fff7cb1b343fdf7671"
      }
    ]
  }
}
```

### Import/Export Account
```
{
  "schema": 3,
  "network": "MAIN_NET",
  "nem_version": "Catapult",
  "data": {
    "encryptedKey": "6714c22c89c81c656....", // vi (32) + encryptedKey (96)
    "salt":"6c9ba0c43cd75b4f323947273db9b6f95aef95695197c0b24a5e10116e3923d1"
  }
}
```
**Note:** We should not directly show the account's privateKey in QR content, the output of "encryptedKey" and "salt" is encrypted data from the account's privateKey + user wallet password, this data format is currently used in NEM wallet (import/Export).

PrivateKey will be [encrypted](https://github.com/QuantumMechanics/NEM-sdk/blob/cd532ca41403123ac1b919b94a7b568982428ec8/src/crypto/cryptoHelpers.js#L17) with user wallet password, and [decrypt](https://github.com/NemProject/NanoWallet/blob/e446b5ed23974506f3694e1d57c9a737ff9d07d2/src/app/modules/importWalletQrCode/importQrCode.controller.js#L177) by user wallet password.

## Implementation

We should create an independent QR library Just like [Apostille-library](https://github.com/luxtagofficial/Apostille-library). it's easy to maintain and update if there is any new QR schema added in.

QR library generates the output and Catapult SDK to do sign transaction and announce.

**Read**
QR code --> QR library Scan --> QR library generate tx output -> SDK sign and announce

**Write**
Define transaction (tx) -> generate QR code

## Backwards compatibility

The previous [QR schemas](https://github.com/QuantumMechanics/NEM-sdk/blob/cd532ca41403123ac1b919b94a7b568982428ec8/src/model/objects/qr.js) used in NIS 1 was not well design and lack of support such as a document. In addition, that is a lot of different variables QR schema in different SDK.

The new QR schema design is not compatible with the previous schemas used in NIS 1, because Catapult and NIS 1 have big different structures design itself.

The idea of creating whole new QR schema is to provide a standardizing QR schema and less complexity. Everyone can use this QR schema to build the application or SDK.

## Drawbacks

we should not involve to many inner transaction inside ***AggregateCompleteTransaction***
because maximum character storage capacity for [QRcode](#wiki-qr-code) max is ***4296 Alphanumeric***

we may able to append many inner transactions, it depends on the transaction content. An example that is 0 message and each transaction are attached 1 asset.

Not all types of transaction are covered right now, but here is the list of the transaction type I thinking the most often used:

- [x] TransferTransaction : transfer asset from one to another one address.
- [x] AggregateTransaction 
   - [x] AggregateCompleteTransaction: transfer multiple transactions by signing used a single private key in one transaction.
   - [ ] AggregateBondedTransaction: transfer multiple transactions and involved multiple parties signing in one transaction.
- [x] CosignatureTransaction: sign transaction by transaction hash. 
- [ ] LockFundsTransaction: Announce a lock funds transaction before sending a signed aggregate bonded transaction. This mechanism is required to prevent network spamming.

- [ ] SecretLockTransaction : Use a secret lock transaction to start the cross-chain swap
- [ ] SecretProofTransaction : Use a secret proof transaction to unlock secret lock transactions.

In the future, if there is any new plugin for the catapult, we can just add the new QR schema.

## Alternatives

For QR content, current JSON object format.
the alternatives will be using [URI](https://www.webfx.com/blog/web-design/qr-codes-uri-schemes/) Query base, the benefit of URI it already has some URI protocol such as open default email or open application apps. Check on this [NIP #6](https://github.com/nemtech/NIP/issues/6)

For **Add Wallet contact** we actually can think of how to use [vCard](https://en.wikipedia.org/wiki/VCard) in our catapult wallet, the advantage of Vcard it can directly save into device contact list.

## References

#### QR Service Library on NIS 1
NEM-SDK : [QR object library](https://github.com/QuantumMechanics/NEM-sdk/blob/9e1d881171eb5c32d61791f8078deba962b56692/src/model/objects/qr.js)
NEM-Library: [QRService library](https://github.com/aleixmorgadas/nem-library-ts/blob/fa649c5854287ee122bd635f2c1507d5218a952e/src/services/QRService.ts)
NEM Android : [Android QR Library](https://github.com/NemProject/NEMAndroidApp/tree/9e9db2233b436e8fdbc35161e52e69171c8c7eb3/app/src/main/java/org/nem/nac/models/qr)

#### Catapult SDK 
Typescript/Javascript : [nem2-sdk-typescript-javascript](https://github.com/nemtech/nem2-sdk-typescript-javascript)
Java : [nem2-sdk-java](https://github.com/nemtech/nem2-sdk-java)
more : [NEMTECH Doc](https://nemtech.github.io/sdk/languages.html)

## Contributors
Special thanks to [@aleixmorgadas](https://github.com/aleixmorgadas) and [@dgarcia360](https://github.com/dgarcia360) for contributing actively to improve this NIP.

## History

| **Date**     | **Version**   |
| ------------ | ------------- |
| July 15 2018 | Initial Draft |
| Aug 6 2018   | Second Draft  |
| Dec 23 2018   | Third Draft  |
